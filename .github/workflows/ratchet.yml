name: Test & Check pinned workflows

on: [ push ]

jobs:
  test-ci:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # ratchet:actions/checkout@v3
      - name: Extract version of Go to use
        run: echo "GOVERSION=$(cat go.mod | grep -w "go" | awk ' { print $2 } ' | grep -w "^[^v]")" >> $GITHUB_ENV
      - uses: actions/setup-go@bfdd3570ce990073878bf10f6b2d79082de49492 # ratchet:actions/setup-go@v2
        with:
          go-version: ${{ env.GOVERSION }}
      - name: Cache Go modules
        uses: actions/cache@48af2dc4a9e8278b89d7fa154b955c30c6aaab09 # ratchet:actions/cache@v3
        id: go-mod-cache
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      - name: Test Salsa
        run: make test

  ratchet:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b # ratchet:actions/checkout@v3

      - name: Check if main.yml is pinned
        uses: 'docker://ghcr.io/sethvargo/ratchet:0.2.1'
        with:
          args: 'check .github/workflows/main.yml'
          entrypoint: /ratchet

      - name: Check if nais-salsa-integration.yml is pinned
        uses: 'docker://ghcr.io/sethvargo/ratchet:0.2.1'
        with:
          args: 'check .github/workflows/nais-salsa-integration.yml'
          entrypoint: /ratchet

      - name: Check if golangci-lint.yml is pinned
        uses: 'docker://ghcr.io/sethvargo/ratchet:0.2.1'
        with:
          args: 'check .github/workflows/nais-salsa-integration.yml'
          entrypoint: /ratchet

      - name: Checks failed
        if: ${{ failure() }}
        run: |
          echo see "'https://github.com/sethvargo/ratchet'" for more information.
          echo "'make check workflow=my_workflow.yml'"
          echo "'make update workflow=my_workflow.yml'"
          echo "'make pin workflow=my_workflow.yml'" for new workflow file && exit 1